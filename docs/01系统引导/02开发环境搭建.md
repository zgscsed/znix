## 配置环境

vmware安装和vscode下载软件安装，在vmware上配置好ubuntu环境。

## 准备步骤
### 1、 vscode 安装remote-ssh插件
 
 接下来依次选择 File->Preferences->Settings->Extensions->Remote-SSH，找到 Show Login Terminal 并勾选。

 安装好remote-ssh插件后，出现下图的图标，点击链接远程linux，如果连接过程不不明白，可以参考其它人的[配置](https://blog.csdn.net/weixin_44042453/article/details/127786698)。

 ![Alt text](images/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-02%20185315.png "remore-ssh插件")

 ### 2、nasm和bochs安装

安装nasm编译器：     
```
sudo apt-get install nasm
```

vscode可以安装 ```MASM/TASM``` 插件, 这样写汇编代码是可以高亮。

----


安装bochs

 下载bochs[源码2.7版本](https://sourceforge.net/projects/bochs/files/bochs/2.7/)  编译,需要准备好编译环境。

 ```
    # 如果报依赖错误，最好先执行 apt-get update 更新一下
    sudo apt-get install build-essential
    sudo apt-get install xorg-dev
    sudo apt-get install bison
    sudo apt-get install libgtk2.0-dev
    sudo apt-get install g++ 

```

编译
```
# 下载源码，然后解压
sudo tar zxvf bochs-2.7.tar.gz
cd bochs-2.7
# 配置， 这两个是用来开启调试和反汇编功能
sudo ./configure --enable-debugger --enable-disasm --enable-debugger-gui

# 编译
make clean
sudo make

# 安装
sudo make install
```
这样bochs安装流程结束。
参考[博客](https://www.cnblogs.com/lfri/p/11489223.html)。

### 实验过程

1、制作引导扇区，把boot.asm编译了，得到boot.bin;
2、制作软盘，并将引导扇区写入；
3、启动bochs, 得到结果

#### 编译
首先需要写好boot.asm文件，然后执行命令
```
nasm -f bin boot.asm -o boot.bin
```

使用vscode 查看boot.bin文件， 可以安装 Hex Editor插件查看二进制文件。

#### 制作硬盘镜像


```
# 创建流程， 执行bximage，然后选择选项1， 创建硬盘镜像
bximage

# 提示输入fd,还是hd, 这里创建硬盘镜像，所以输入
hd

# 选择kind， 输入flat
flat

# 选择硬盘扇区大小
512

# 选择硬盘大小, 单位MB
16

# 硬盘镜像名称
master.img
```

也可以使用命令创建
```
bximage -q -hd=16 -func=create -sectsize=512 -imgmode=flat master.img
```

boot.bin 写入主引导扇区

```
dd if=boot.bin of=master.img bs=512 count=1 conv=notrunc
```

#### 配置bochs

```
ata0-master: type=disk, path="master.img", mode=flat
```

bochs配置参数，导出流程：
```
# 执行命令
bochs -q

# 选择 save options to...选项
4

# 文件名
bochsrc

# 选择quit now选项退出，7
7
```

bochs配置参数如下：

修改点：
dispaly_library:
boot:
ata0-master:

```ini
# configuration file generated by Bochs
plugin_ctrl: unmapped=true, biosdev=true, speaker=true, extfpuirq=true, parallel=true, serial=true, iodebug=true
config_interface: textconfig
display_library: x, options="gui_debug"
memory: host=32, guest=32
romimage: file="/usr/local/share/bochs/BIOS-bochs-latest", address=0x00000000, options=none
vgaromimage: file="/usr/local/share/bochs/VGABIOS-lgpl-latest"
boot: disk
floppy_bootsig_check: disabled=0
floppya: type=1_44
# no floppyb
ata0: enabled=true, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14
ata0-master: type=disk, path="master.img", mode=flat
ata0-slave: type=none
ata1: enabled=true, ioaddr1=0x170, ioaddr2=0x370, irq=15
ata1-master: type=none
ata1-slave: type=none
ata2: enabled=false
ata3: enabled=false
optromimage1: file=none
optromimage2: file=none
optromimage3: file=none
optromimage4: file=none
optramimage1: file=none
optramimage2: file=none
optramimage3: file=none
optramimage4: file=none
pci: enabled=1, chipset=i440fx, slot1=none, slot2=none, slot3=none, slot4=none, slot5=none
vga: extension=vbe, update_freq=5, realtime=1, ddc=builtin
cpu: count=1, ips=4000000, model=bx_generic, reset_on_triple_fault=1, cpuid_limit_winnt=0, ignore_bad_msrs=1, mwait_is_nop=0
cpuid: level=6, stepping=3, model=3, family=6, vendor_string="GenuineIntel", brand_string="              Intel(R) Pentium(R) 4 CPU        "
cpuid: mmx=true, apic=xapic, simd=sse2, sse4a=false, misaligned_sse=false, sep=true
cpuid: movbe=false, adx=false, aes=false, sha=false, xsave=false, xsaveopt=false, smep=false
cpuid: smap=false, mwait=true
print_timestamps: enabled=0
debugger_log: -
magic_break: enabled=0
port_e9_hack: enabled=0
private_colormap: enabled=0
clock: sync=none, time0=local, rtc_sync=0
# no cmosimage
log: -
logprefix: %t%e%d
debug: action=ignore
info: action=report
error: action=report
panic: action=ask
keyboard: type=mf, serial_delay=250, paste_delay=100000, user_shortcut=none
mouse: type=ps2, enabled=false, toggle=ctrl+mbutton
speaker: enabled=true, mode=system
parport1: enabled=true, file=none
parport2: enabled=false
com1: enabled=true, mode=null
com2: enabled=false
com3: enabled=false
com4: enabled=false
```